// 請找到 HTML 裡的 setup() 區塊並替換以下邏輯
setup() {
    const user = ref(null);
    const loading = ref(true);
    const transactions = ref([]);
    const showModal = ref(false);
    const editingId = ref(null);
    const prices = ref({});
    const chartInstances = {};
    const historyState = ref({});
    const historyRecords = ref({});

    const form = ref({
        date: new Date().toISOString().split('T')[0],
        ticker: '', type: 'Buy', price: 0, shares: 0
    });

    const formatNumber = (num) => {
        if (num === undefined || num === null) return '0.00';
        return Number(num).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    };

    const portfolioList = computed(() => {
        const groups = {};
        transactions.value.forEach(t => {
            if (!groups[t.ticker]) {
                groups[t.ticker] = { ticker: t.ticker, transactions: [], shares: 0, totalCost: 0 };
            }
            groups[t.ticker].transactions.push(t);
        });

        return Object.values(groups).map(stock => {
            stock.transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            stock.shares = 0; stock.totalCost = 0;
            
            stock.transactions.forEach(t => {
                const p = parseFloat(t.price);
                const s = parseFloat(t.shares);
                if (t.type === 'Buy') { stock.totalCost += p * s; stock.shares += s; }
                else if (t.type === 'Sell' && stock.shares > 0) {
                    const ratio = s / stock.shares;
                    stock.totalCost -= stock.totalCost * ratio;
                    stock.shares -= s;
                }
                else if (t.type === 'Split') { stock.shares *= p; }
            });

            stock.avgCost = stock.shares > 0 ? stock.totalCost / stock.shares : 0;
            
            // --- 核心修改：讀取機器人存下的真實價格 ---
            stock.history = historyRecords.value[stock.ticker] || [];
            if (stock.history.length > 0) {
                // 抓取時間戳記最新的一筆
                const latest = [...stock.history].sort((a, b) => b.timestamp - a.timestamp)[0];
                stock.currentPrice = latest.price;
                stock.isRealData = true; 
            } else {
                stock.currentPrice = 0; // 尚未有紀錄
                stock.isRealData = false;
            }

            stock.marketValue = stock.shares * stock.currentPrice;
            stock.profit = stock.marketValue - stock.totalCost;
            stock.profitPercent = stock.totalCost > 0 ? ((stock.profit / stock.totalCost) * 100).toFixed(2) : 0;
            
            nextTick(() => renderChart(stock));
            return stock;
        }).filter(s => s.shares > 0.001);
    });

    // 登入、登出、Firebase 監聽邏輯與先前版本保持一致...
    // (此處省略以節省空間，請保留您原本的 onMounted 內容)

    return {
        user, loading, login, logout, 
        showModal, openModal, closeModal, form, saveTransaction, editingId,
        portfolioList, totalPortfolioValueUSD, totalCostUSD, totalUnrealizedPL,
        formatNumber, historyState, toggleHistory, deleteTransaction,
        formatType: (type) => ({'Buy':'買入','Sell':'賣出','Split':'拆分'}[type])
    };
}
